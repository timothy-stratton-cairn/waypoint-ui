<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Protocol Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div th:insert="~{header :: main}">...</div>

<div id="banner" class="alert" role="alert" style="display: none;"></div>
<div class="container">
    <div class="row note_card">
        <fieldset>
            <legend>Protocol Template Details</legend>
            <div>
                <form action="#" th:action="@{/saveProtocol}" th:object="${protocol}" method="post">
                    <div class="row">
                        <div class="col-md-1">
                            <label for="name" class="mr-md-3"><strong>Name:</strong></label>
                        </div>
                        <div class="col-md-5">
                            <input type="text" id="name" name="name" th:value="${protocol.name}" class="form-control" />
                        </div>
                        <div class="col-md-1">
                            <label for="status" class="mr-md-3"><strong>Status:</strong></label>
                        </div>
                        <div class="col-md-2">
                            <select id="status" name="status" class="form-control">
                                <option value="LIVE" th:selected="${protocol.status == 'LIVE'}">Live</option>
                                <option value="INACTIVE" th:selected="${protocol.status == 'INACTIVE'}">Inactive</option>
                                <option value="ARCHIVED" th:selected="${protocol.status == 'ARCHIVED'}">Archived</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label for="status" class="mr-md-3"><strong>Category:</strong></label>
                        </div>
                        <div class="col-md-2">
                            <select id="type" name="type" class="form-control">
                                <option value="EVENT_DRIVEN" th:selected="${protocol.type == 'EVENT_DRIVEN'}">Event Driven</option>
                                <option value="LIFECYCLE" th:selected="${protocol.type== 'LIFECYCLE'}">Life Cycle</option>
                            </select>
                        </div>
                        
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-md-1">
                            <label for="description"><strong>Description:</strong></label>
                        </div>
                        <div class="col-md-11">
                            <input type="text" id="description" name="description" th:value="${protocol.description}" class="form-control"/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="row mt-3">
                <div class="col-md-2">
                    <label for="dueDate" class="mr-md-1"><strong>Default Due Date: </strong></label>
                </div>
                <div class="col-md-2">
                    <label for="dueDateYear" class="d-inline"><strong>Year</strong></label>
                    <input type="number" class="form-control d-inline" id="dueDateYear" name="year" th:value="${protocol.dueByYear}" min="0" max="10" style="width: 40%;">
                </div>
                <div class="col-md-2">
                    <label for="dueDateMonth" class="d-inline"><strong>Month</strong></label>
                    <input type="number" class="form-control d-inline" id="dueDateMonth" name="month" th:value="${protocol.dueByMonth}" min="0" max="12" style="width: 40%;">
                </div>
                <div class="col-md-2">
                    <label for="dueDateDay" class="d-inline"><strong>Day</strong></label>
                    <input type="number" class="form-control d-inline" id="dueDateDay" name="day" th:value="${protocol.dueByDay}" min="0" max="31" style="width: 40%;">
                </div>
            </div>
            <br>
            <div class="border border-dark p-3 mb-3">
                <div class="row">
                    <div class="col-md-2">
                        <label for="reoccurring" class="mr-md-"><strong>Default as Reoccurring?</strong></label>
                        <input type="checkbox" id="reoccurring" name="reoccurring"/>
                    </div>
                </div>
                <div id="schedule-fields" style="display: none;">
                    <div class="row mt-3">
                        <div class="col-md-2">
                            <label for="schedule" class="mr-md-1"><strong>Default Schedule?</strong></label>
                        </div>
                        <div class="col-md-2">
                            <label for="year" class="d-inline"><strong>Year</strong></label>
                            <input type="number" class="form-control d-inline" id="year" name="year" th:value= "${protocol.yearSchedule}" min="0" max="10" style="width: 40%;">
                        </div>
                        <div class="col-md-2">
                            <label for="month" class="d-inline"><strong>Month</strong></label>
                            <input type="number" class="form-control d-inline" id="month" name="month" th:value= "${protocol.monthSchedule}" min="0" max="12" style="width: 40%;">
                        </div>
                        <div class="col-md-2">
                            <label for="day" class="d-inline"><strong>Day</strong></label>
                            <input type="number" class="form-control d-inline" id="day" name="day" th:value= "${protocol.daySchedule}" min="0" max="31" style="width: 40%;">
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="history.back()" class="btn btn-primary">Back</button>
            <button type="button" class="btn btn-primary" th:attr="onclick='deleteProtocolTemplate('+${protocol.id}+');'">Delete</button>
            <button type="button" class="btn btn-success" th:attr="onclick='saveProtocol('+${protocol.id}+');'">Save Protocol</button>
        </fieldset>
    </div>

    <div class="row note_card">
        <fieldset>
            <legend>Assigned Homework</legend>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Homework Name</th>
                            <th>Step Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <th:block th:with="hasHomework=false">
                            <th:block th:each="step : ${steps}">
                                <th:block th:each="homework : ${step.homework}">
                                    <th:block th:if="${not #lists.isEmpty(step.homework)}" th:with="hasHomework=true">
                                        <tr>
                                            <td th:text="${homework.name}">[Homework Name]</td>
                                            <td th:text="${step.name}">[Step Name]</td>
                                            <td>
                                                <button type="button" class="btn btn-primary" th:attr="onclick='viewHomeworkDetails('+${homework.id}+');'">Details</button>
                                            </td>
                                        </tr>
                                    </th:block>
                                </th:block>
                            </th:block>
                        </th:block>
                    </tbody>
                </table>
            </div>
        </fieldset>
    </div>

    <!-- Steps Section with Tabs -->
    <div class="row note_card">
        <fieldset>
            <legend>Steps</legend>
            
            <!-- Tabs for filtering steps -->
            <ul class="nav nav-tabs">
                <li class="nav-item tab"><a class="nav-link active" href="#" data-type="all">All</a></li>
                <li class="nav-item tab"><a class="nav-link" href="#" data-type="1">Gather Data</a></li>
                <li class="nav-item tab"><a class="nav-link" href="#" data-type="2">Run Analysis</a></li>
                <li class="nav-item tab"><a class="nav-link" href="#" data-type="3">Craft Recommendations</a></li>
                <li class="nav-item tab"><a class="nav-link" href="#" data-type="4">Share Education</a></li>
            </ul>

            <div id="stepsContent">
                <!-- Steps will be dynamically loaded here -->
            </div>
            <br>

            <!-- Template for adding new step -->
            <template id="stepTemplate">
                <div class="new-step-row">
                    <select class="form-control" name="newid">
                        <option th:each="step : ${allSteps}" th:value="${step.id}" th:text="${step.name}"></option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="confirmStep(this);">Confirm</button>
                </div>
            </template>
            <div id="stepsContainer">
                <!-- New step rows will be appended here -->
            </div>
            <br>
            
            <button type="button" class="btn btn-primary" onclick="newStep();">Create New Step</button>
            <button type="button" class="btn btn-primary" onclick="addStep();">Add Existing Step</button>
        </fieldset>
    </div>
</div>

<script>
    var protocolId = [[${protocol.id}]];

    function newStep() {
        window.location = '/newStep/' + protocolId;
    }

    function addStep() {
        var stepsContainer = document.getElementById('stepsContainer');
        var stepTemplate = document.getElementById('stepTemplate').content.cloneNode(true);
        stepsContainer.appendChild(stepTemplate);
    }

    function viewHomeworkDetails(homeworkId) {
        window.location = '/viewHomeworkTemplate/' + homeworkId + '/';
    }

    function editProtocol(id) {
        window.location = '/editStep/' + id;
    }

    function saveProtocol(id) {
        var name = $('#name').val();
        var description = $('#description').val();
        var dueByYears = parseInt($('#dueDateYear').val()) || 0;
        var dueByMonths = parseInt($('#dueDateMonth').val()) || 0;
        var dueByDays = parseInt($('#dueDateDay').val()) || 0;
        var reoccurYears = parseInt($('#year').val()) || 0;
        var reoccurMonths = parseInt($('#month').val()) || 0;
        var reoccurDays = parseInt($('#day').val()) || 0;
        var status = $('#status').val();
        var type = $('#type').val();
        var csrfToken = $('meta[name="_csrf"]').attr('content');
        var csrfHeader = $('meta[name="_csrf_header"]').attr('content');

        var data = {
            name: name,
            description: description,
            dueByYear: dueByYears,
            dueByMonth: dueByMonths,
            dueByDay: dueByDays,
            type: type,
            yearSchedule: reoccurYears,
            monthSchedule: reoccurMonths,
            daySchedule: reoccurDays,
            status: status
        };

        $.ajax({
            url: `/updateProtocolTemplate/${id}`,
            type: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            data: JSON.stringify(data),
            success: function(response) {
                showBannerMessage(response, "success");
                console.log(response);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                var errorMessage = parseErrorMessage(xhr);
                showBannerMessage(errorMessage, "danger");
            }
        });
    }

    function deleteStep(id) {
        var csrfToken = $('meta[name="_csrf"]').attr('content');
        var csrfHeader = $('meta[name="_csrf_header"]').attr('content');

        $.ajax({
            url: `/removeStepFromTemplate/${protocolId}/${id}`,
            type: 'DELETE',
            headers: {
                'Accept': 'application/json, text/plain',
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            success: function(response) {
                showBannerMessage(response, "success");
                updateDisplayedSteps();
            },
            error: function(xhr, status, error) {
                console.error('Error deleting step:', error);
                var errorMessage = parseErrorMessage(xhr);
                showBannerMessage('Failed to delete the step. Error: ' + errorMessage, "danger");
            }
        });
    }

    function confirmStep(buttonElement) {
        var csrfToken = $('meta[name="_csrf"]').attr('content');
        var csrfHeader = $('meta[name="_csrf_header"]').attr('content');

        var selectElement = $(buttonElement).prev();
        var stepId = selectElement.val();

        var stepExists = $(`#stepsContent > div#row_${stepId}`).length > 0;

        if (stepExists) {
            showBannerMessage('Step has already been assigned to template.', 'danger');
            return;
        }

        $.ajax({
            url: `/addStepToProtocol/` + protocolId + `/` + stepId,
            type: 'PATCH',
            headers: {
                'Accept': 'application/json, text/plain',
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            success: function() {
                showBannerMessage("Step added successfully.", "success");
                updateDisplayedSteps();
            },
            error: function(xhr, status, error) {
                console.error('Error adding step:', error);
                var errorMessage = parseErrorMessage(xhr);
                showBannerMessage('Failed to add the step. Error: ' + errorMessage, "danger");
            }
        });
    }

    function showBannerMessage(message, type) {
        var banner = $('#banner');
        banner.removeClass().addClass('alert alert-' + type).text(message).show();
    }

    function updateDisplayedSteps() {
        $.ajax({
            url: `/api/protocols/${protocolId}/steps`,
            type: 'GET',
            success: function(steps) {
                var stepsContent = $('#stepsContent');
                stepsContent.empty();
                steps.forEach(function(step, index) {
                    var stepHtml = `
                        <div id="row_${step.id}" class="row ${index % 2 == 0 ? 'even' : 'odd'}" data-type="${step.categoryId}">
                            <div class="col">${step.name}</div>
                            <div class="col">
                                <button type="button" class="btn btn-secondary" onclick="editProtocol(${step.id});">Details</button>
                                <button type="button" class="btn btn-secondary" onclick="deleteStep(${step.id});">Delete</button>
                            </div>
                        </div>`;
                    stepsContent.append(stepHtml);
                });
                if (steps.length === 0) {
                    stepsContent.append('<p>No steps available.</p>');
                }
                filterSteps('all');
            },
            error: function(xhr, status, error) {
                console.error('Error fetching steps:', error);
                var errorMessage = parseErrorMessage(xhr);
                showBannerMessage('Failed to fetch steps. Error: ' + errorMessage, "danger");
            }
        });
    }

    $(document).ready(function() {
        $('#schedule-fields').hide();
        $('#reoccurring').change(function() {
            if ($(this).is(':checked')) {
                $('#schedule-fields').show();
            } else {
                $('#schedule-fields').hide();
            }
        });

        $('.nav-link').on('click', function(e) {
            e.preventDefault();
            var type = $(this).data('type');
            filterSteps(type);

            $('.nav-link').removeClass('active');
            $(this).addClass('active');
        });

        updateDisplayedSteps();
    });

    function filterSteps(type) {
        $('#stepsContent > div').each(function() {
            var stepType = $(this).data('type');
            if (type === 'all' || stepType == type) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    function parseErrorMessage(xhr) {
        var errorMessage = "An error occurred.";
        try {
            var responseJson = JSON.parse(xhr.responseText);
            if (responseJson.message) {
                errorMessage = responseJson.message;
            }
        } catch (e) {
            console.error('Error parsing error response:', e);
        }
        return errorMessage;
    }
    
    function deleteProtocolTemplate(id) {
        var protocolName = document.getElementById('name').value;
        var isConfirmed = confirm(`Are you sure you want to delete ${protocolName}?`);

        if (!isConfirmed) {
            return;
        }
        var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        $.ajax({
            url: '/deleteTemplate/ProtocolTemplate/' + id,
            type: 'DELETE',
            headers: {
                'Accept': 'application/json, text/plain', 
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            success: function(response) {
                window.location.href = '/protocolTemplates';

            },
            error: function(xhr, status, error) {
                showBannerMessage( xhr.responseText, 'danger');


            }
        });
    }
</script>
<div th:insert="~{footer :: main}">...</div>
</body>
</html>

