<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">
<head>
	<meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Protocol Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script>
		var protocolId = [[${protocolId}]]; 
		
        function editProtocol(stepId) {
            window.location = '/editStep_admin/' + stepId;
        }
        function disableProtocol(id) {
            alert('Disable feature for protocol ID ' + id + ' is not implemented yet.');
        }
        function saveprotocol(){
			alert('Protocol Saved')
		}
		function addStep() {
            const container = document.querySelector("#stepsContainer");
            const template = document.querySelector("#stepTemplate").content.cloneNode(true);
            container.appendChild(template);
        }

		function confirmStep(buttonElement) {
		    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
			var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

		    var stepId = buttonElement.previousElementSibling.value; 
		    var protocolIdId = protocolId;
		    
		    fetch(`/addStepToProtocol/${protocolId}`, {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		        },
		        body: JSON.stringify(stepId),
		    })
		    .then(response => {
		        if(response.ok) {
		            alert("Step added successfully.");
		            window.location.reload(); // if successfull reload page.
		        } else {
		            alert("Failed to add the step.");
		        }
		    })
		    .catch(error => console.error('Error adding step:', error));
		}

    </script>
</head>
<body>
<div th:insert="~{header :: main}">...</div>
<div class="container">
    <!-- Protocol Details Form for New Protocol (ID = 0) -->
    <div th:if="${protocol.id == null || protocol.id == 0}">
        <div class="row note_card">
            <fieldset>
                <legend>Protocol Details</legend>
                <form action="#" th:action="@{/saveProtocol}" th:object="${protocol}" method="post">
                    <div>
                        <label for="name"><strong>Name:</strong></label>
                        <input type="text" id="name" name="name" th:value="${protocol.name}" />
                    </div>
                    <button type="button" class="btn btn-secondary" th:onclick="saveprotocol()">Save</button>
                </form>
            </fieldset>
        </div>
    </div>

    <!-- Protocol Details Display for Existing Protocol -->
    <div th:if="${protocol.id != null && protocol.id > 0}">
        <div class="row note_card">
            <fieldset>
                <legend>Protocol Details</legend>
                <div>
                    <strong>ID:</strong> <span th:text="${protocol.id}"></span>
                </div>
                <div>
                    <strong>Name:</strong> <span th:text="${protocol.name}"></span>
                </div>
            </fieldset>
        </div>
    </div>
    
    <!-- Steps Section (Always Displayed, but empty if no steps) -->
    <div class="row note_card">
        <fieldset>
            <legend>Steps</legend>
            <div class="row">
                <div class="col">
                    <label>Step Name</label>
                </div>
                <div class="col">
                    <label>Actions</label>
                </div>
            </div>
            <div th:each="step, status : ${steps}" th:id="|row_${step.stepId}|"
                 th:class="${status.index % 2 == 0 ? 'row even' : 'row odd'}">
                <div class="col" th:text="${step.stepName}">[Step Name]</div>
                <div class="col">
                    <button type="button" class="btn btn-secondary" th:onclick="'editProtocol('+${step.stepId}+');'">Details</button>
                    <button type="button" class="btn btn-danger" th:onclick="'disableProtocol('+${step.stepId}+');'">Disable</button>
                </div>
            </div>
            <div th:if="${steps.empty}">
                <p>No steps available.</p>
            </div>
            <button type="button" class="btn btn-secondary" th:onclick="'editProtocol(0);'">New Step</button>
            <button type="button" class="btn btn-primary" onclick="addStep();">Add Step</button>
	            <template id="stepTemplate">
	                <div class="new-step-row">
	                    <select class="form-control" name="newStepId">
	                        <option th:each="step : ${allSteps}" th:value="${step.stepId}" th:text="${step.stepName}"></option>
	                    </select>
	                    <button type="button" class="btn btn-secondary" onclick="confirmStep(this);">Confirm</button>
	                </div>
	            </template>
	            <div id="stepsContainer">
				    <!-- New step rows will be appended here -->
				</div>
        </fieldset>
    </div>
</div>
<div class="container mt-3">
    <a th:href="@{/protocols_admin}" class="btn btn-primary">Back</a>
</div>
</body>
</html>

