<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Client Profile</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body data-client-id="${clientId}">
    <div th:insert="~{header :: main}">...</div>

    <div class="container">
        <!-- Client Information -->
        <div class="note_card">
            <fieldset>
                <legend> Household</legend>
                
                <button onclick="history.back()" class="btn btn-primary">Back</button>
				<div class="row mb-3">
				    <div class="col-md-3">
				        <label>Name:</label>
				        <span th:text="${client.name}"></span>
				    </div>
				</div>

                <!-- CoClients -->
				<div class="row mb-3">
					    <div class="col-md-3">
					        <label>Primary Contact:</label>
					        <span th:each="client : ${primaryContact}" th:text="${client.firstName + ' ' + client.lastName}"></span>
					    </div>
					    <div class="col-md-3">
					        <label>Email:</label>
					        <span th:each="client : ${primaryContact}" th:text="${client.email}"></span>
					    </div>
					    <!--<div class="col-md-3">
					        <label>Phone:</label>
					        <span th:text="${client.phoneNumber}"></span>
					    </div>-->
					    <div class="col-md-3">

					        <a class="btn btn-sm btn-secondary" th:each="client : ${primaryContact}" th:href="${'javascript:editClient(' + client.id + ');'}">Edit</a>
					    </div>
					</div>

				
				<div class="row mb-3">
				    <div class="col-md-12">
				        <table class="table">
				            <thead>
				                <tr>
				                    <th>CoClients</th>
				                    <th>Action</th>
				                </tr>
				            </thead>
				            <tbody>
				                <tr th:each="coclient : ${coClientList}">
				                    <td th:text="${coclient.firstName + ' ' + coclient.lastName}"></td>
				                    <td>
				                       <a class="btn btn-sm btn-secondary" th:href="${'javascript:editClient(' + coclient.id + ');'}">Edit</a>
				                    </td>
				                </tr>
				            </tbody>
				        </table>
				    </div>
				</div>

				    <div class="col-3">
                        <div class="input-group">
                            <select class="form-select" id="coClientSelect">
                                <option value="">Select CoClient</option>
                                <!-- Populate dropdown menu with CoClient list -->
                                <option th:each="coClient : ${userList}" th:value="${coClient.id}" th:text="${coClient.firstName} + ' ' + ${coClient.lastName}"></option>
                            </select>
                            <button class="btn btn-primary" type="button" onclick="addCoClient()">Add CoClient</button>
                        </div>
                    </div>
			<br>


            </fieldset>
        </div>
    </div>

    <div class="container">
        <!-- Dependents Information -->
        <div class="note_card">
            <fieldset>
                <legend>Dependents</legend>
                <ul class="nav nav-tabs" id="dependentTabs" role="tablist">
                    <li class="nav-item" th:each="dependent, iterStat : ${clientList}" th:if="${dependent.roles.contains('DEPENDENT')}" role="presentation">
                        <button class="nav-link" th:id="'dependent-tab' + ${iterStat.index}" data-bs-toggle="tab" th:data-bs-target="'#dependent' + ${iterStat.index}" type="button" role="tab" th:text="${dependent.firstName} + ' ' + ${dependent.lastName}"></button>
                    </li>
                </ul>
                <div class="tab-content" id="dependentTabsContent">
                    <div th:each="dependent, iterStat : ${clientList}" th:if="${dependent.roles.contains('DEPENDENT')}" class="tab-pane fade" th:id="'dependent' + ${iterStat.index}" role="tabpanel">
                        <div>
                            <label>Id:</label>
                            <span th:text="${dependent.id}"></span>
                        </div>
                        <div>
                            <label>Username:</label>
                            <span th:text="${dependent.username}"></span>
                        </div>
                        <div>
                            <label>Name:</label>
                            <span th:text="${dependent.firstName} + ' ' + ${dependent.lastName}"></span>
                        </div>
                    </div>
                </div>
                <a class="btn btn-sm btn-secondary" th:href="${'javascript:addDependant(' + client.id + ');'}">Add Dependant</a>
            </fieldset>
        </div>
    </div>

    <div class="container">
        <div class="note_card">
            <fieldset>
                <legend>Assigned Protocols</legend>
                <ul class="nav nav-tabs">
                    <li class="nav-item tab"><a class="nav-link active" href="#" onclick="filterProtocolsByStatus('all'); return false;">All</a></li>
                    <li class="nav-item tab"><a class="nav-link" href="#" onclick="filterProtocolsByStatus('IN_PROGRESS'); return false;">Active Protocols</a></li>
                    <li class="nav-item tab"><a class="nav-link" href="#" onclick="filterProtocolsByStatus('COMPLETED'); return false;">Completed Protocols</a></li>
                    <li class="nav-item tab"><a class="nav-link" href="#" onclick="filterProtocolsByStatus('ARCHIVED'); return false;">Archived Protocols</a></li>
                </ul>

                <div class="row">
                    <div class="col-2">
                        <input type="text" id="protocolSearch" class="form-control" placeholder="Search protocols...">
                    </div>
                </div>

                <div class="row" id="protocolContent">
                    <!-- Display Assigned Protocols -->
                    <div th:each="pcol, status: ${assignedProtocols}" th:id="|row_${pcol.id}|" class="note_card col-md-5" th:data-type="${pcol.status}">
                        <a th:href="@{/viewProtocol/{id}/{userId}(id=${pcol.id}, userId=${userId})}">
                            <div class="flip-card ">
                                <div class="flip-card-inner">
                                    <div class="flip-card-front">
                                        <div class="container">
                                            <div class="row" th:text="${pcol.name}"></div>
                                            <hr />

                                            <div class="row">
                                                <div class="row col-md-6" th:text="|Goal: ${pcol.goal}|"></div>
                                                <div class="row col-md-6" th:text="|Progress: ${pcol.progress}|"></div>
                                            </div>

                                            <div class="row">
                                                <div class="row col-md-6" th:text="|Total Steps: ${pcol.stepCount}|"></div>
                                                <div class="row col-md-6" th:text="|Completed: ${pcol.completedSteps}|"></div>
                                            </div>

                                            <div class='row' th:text="|Description: ${pcol.description}"></div>

                                            <hr />
                                            <!-- Actionable Items Section -->
                                            <li th:each="step : ${pcol.steps}" th:if="${step.status != 'Done'}" th:text="${step.name + ' - ' + step.status}"></li>
                                        </div>
                                    </div>
                                    <div class="flip-card-back">
                                        <p>Actionable Items:</p>
                                        <li th:each="step : ${pcol.steps}" th:if="${step.status != 'Done'}" th:text="${step.name + ' - ' + step.status}"></li>
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="row">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-secondary" onclick="flipCard(this.closest('.note_card').querySelector('.flip-card'))">Flip</button>
                            </div>
                            <div class="col-md-8">
                                <button class="btn btn-secondary" th:attr="onclick=|goToHomeworks('${pcol.id}');|">Homework</button>&nbsp;&nbsp;
                                <button class="btn btn-secondary" th:attr="onclick=|viewAnalysis('${pcol.id}');|">Analysis</button>&nbsp;&nbsp;
                                <button class="btn btn-secondary" th:attr="onclick=|protocolHistory('${pcol.name}');|">History</button>&nbsp;&nbsp;
                                <button class="btn btn-secondary" th:attr="onclick=|viewRecommendations('${pcol.id}');|">Recommendations</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-3">
                        <button type="button" class="btn btn-primary" onclick="addProtocol();">Add Protocol</button>
                        <button type="button" class="btn btn-primary" onclick="viewHistory();">View All Protocols</button>
                    </div>
                </div>
            </fieldset>
            <div id="protocolContainer"></div>
        </div>
    </div>

    <!--template for new protocol drop down -->
    <template id="protocolTemplate">
        <div class="new-protocol-row mb-3">
            <select class="form-control" name="newProtocolId">
                <option value="">Select Protocol</option>
                <option th:each="protocol : ${protocolList}" th:value="${protocol.id}" th:text="${protocol.name}"></option>
            </select>
            <button type="button" class="btn btn-secondary" onclick="confirmProtocol(this);">Confirm</button>
        </div>
    </template>
	


	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

	<script th:inline="javascript">
	 	var clientId = [[${clientId}]];
	   function addDependant(id){
		   window.location = '/createDependant/'+id;
	   }
	   function viewAnalysis(id){
		   window.location= '/analysis/'+id;
	   }
	   function viewHistory(){
		   window.location='/allClientProtocols/'+clientId;
	   }
	   function protocolHistory(name){
		   window.location='/protocolHistory/'+clientId+'/'+name;
	   }
	   function viewRecommendations(id){
		   window.location= '/protocolRecommendations/'+id +'/'+clientId;
	   }
	   
	   	function goToHomeworkTemplates() {
			window.location.href = '/homeworkList/';
		}
		function goToHomeworks(id) {
			window.location.href = '/homeworkList/'+id;
		}
		function editClient(id){
			window.location.href= '/changeClientInfo/'+id;
		}
		
		// Activate the first tab by default
		var firstTabEl = document.querySelector('#dependentTabs .nav-link');
		var firstTab = new bootstrap.Tab(firstTabEl);
		var apTracker = true; // used to prevent addProtocol from spawning multiple lines 

		if (firstTabEl) {
			firstTab.show();
		}

		function addProtocol() {
		    if (!apTracker) {
		        console.log("addProtocol: Prevented from spawning multiple lines.");
		        return; // Exit the function early if apTracker is false
		    }
		    
		    console.log("addProtocol: Function called.");
		    const container = document.querySelector("#protocolContainer");
		    if (container) {
		        console.log("addProtocol: Container found.");
		    } else {
		        console.error("addProtocol: #protocolContainer not found.");
		        return; // Also exit early if the container is not found
		    }
		    const template = document.querySelector("#protocolTemplate").content.cloneNode(true);
		    container.appendChild(template);
		    console.log("addProtocol: Protocol added to container.");
		    apTracker = false; // Set apTracker to false to prevent further addition until it's reset
		}
		function confirmProtocol(buttonElement) {
			console.log("confirmProtocol: Function called.");

			// Retrieve CSRF token elements
			var csrfTokenElement = document.querySelector('meta[name="_csrf"]');
			var csrfHeaderElement = document.querySelector('meta[name="_csrf_header"]');
			var csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : 'no_token';
			var csrfHeader = csrfHeaderElement ? csrfHeaderElement.getAttribute('content') : 'no_header';
			if (csrfTokenElement && csrfHeaderElement) {
				console.log("confirmProtocol: CSRF elements found.");
			} else {
				console.error("confirmProtocol: CSRF elements not found. This will cause the fetch call to fail.");
			}

			// Retrieve selected protocol ID
			var selectElement = buttonElement.previousElementSibling;
			var protocolId = selectElement ? selectElement.value : null;
			
		    const popupWidth = 800;
		    const popupHeight = 400;
		    const left = (screen.width - popupWidth) / 2;
		    const top = (screen.height - popupHeight) / 2;
		    window.open(`/extraInfoPopUp/${clientId}/${protocolId}`, 'extraInfoPopUp', `width=${popupWidth},height=${popupHeight},top=${top},left=${left}`);
			if (protocolId) {
				console.log(`confirmProtocol: Selected protocol ID is ${protocolId}.`);
			} else {
				console.error("confirmProtocol: No protocol ID selected.");
				return; // Exit the function if no protocol ID is selected
			}

			// Perform the PATCH request
			fetch(`/addClientToProtocol/[[${clientId}]]/` + protocolId, {
				method: 'POST',
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json',
					[csrfHeader]: csrfToken
				},
				credentials: 'include'
			})
				.then(response => {
					console.log(`confirmProtocol: Fetch response status is ${response.status}.`);
					if (response.ok) {
						apTracker = true;
						window.location.reload(); // Reload page if successful
					} else {
						response.text().then(text => {throw new Error(text);});
					}
				})
				.catch(error => {
					console.error('Error adding step:', error);
					alert('Failed to add the Protocol. Error: ' + error.message);
				});

		}


		document.addEventListener('DOMContentLoaded', function () {
			var searchField = document.getElementById('protocolSearch');

			searchField.addEventListener('input', function () {
				var searchTerm = this.value.toLowerCase();

				// Select all protocol entries
				var protocols = document.querySelectorAll('.note_card.col-md-5');

				protocols.forEach(function (protocol) {
					// Query for name, goal, progress, and description elements within each protocol card
					var nameElement = protocol.querySelector('.flip-card-front .container .row:first-child');
					var goalElement = protocol.querySelector('.flip-card-front .container .row:nth-child(3) .row');
					var progressElement = protocol.querySelector('.flip-card-front .container .row:nth-child(4) .row');
					var descriptionElement = protocol.querySelector('.flip-card-front .container .row:nth-child(5)');

					// Extract text content if elements are found, otherwise use an empty string
					var name = nameElement ? nameElement.textContent.toLowerCase() : '';
					var goal = goalElement ? goalElement.textContent.toLowerCase() : '';
					var progress = progressElement ? progressElement.textContent.toLowerCase() : '';
					var description = descriptionElement ? descriptionElement.textContent.toLowerCase() : '';

					// Check if the protocol card should be displayed based on the search term presence
					var isMatch = name.includes(searchTerm) || goal.includes(searchTerm) || progress.includes(searchTerm) || description.includes(searchTerm);

					// Query and check steps for matching names
					var steps = protocol.querySelectorAll('.flip-card-back li');
					steps.forEach(function (step) {
						var stepName = step.textContent.toLowerCase();
						if (stepName.includes(searchTerm)) {
							isMatch = true;
						}
					});

					protocol.style.display = isMatch ? '' : 'none'; // Show or hide the protocol card
				});
			});
		});
		
        function filterProtocolsByStatus(status) {
            const protocols = document.querySelectorAll('#protocolContent > div');
            let visibleProtocolsCount = 0;

            console.log(`Filtering protocols by status: ${status}`); // Log the status being filtered on

            protocols.forEach(protocol => {
                console.log(`Protocol status: ${protocol.getAttribute('data-type')}`); // Log each protocol's status before comparison
                if (status === 'all' || protocol.getAttribute('data-type') === status) {
                    protocol.style.display = ''; // Show
                    visibleProtocolsCount++;
                } else {
                    protocol.style.display = 'none'; // Hide
                }
            });

            console.log(`Total visible protocols: ${visibleProtocolsCount}`); // Log the count of visible protocols after filtering

            // Check if there are no visible protocols and display a message
            const noProtocolsMessage = document.getElementById('noProtocolsMessage');
            if (visibleProtocolsCount === 0) {
                if (!noProtocolsMessage) {
                    const message = document.createElement('div');
                    message.id = 'noProtocolsMessage';
                    message.className = 'alert alert-warning';
                    message.textContent = 'No protocols found for this status';
                    document.getElementById('protocolContent').appendChild(message);
                    
                } else {
                    noProtocolsMessage.style.display = ''; // Show existing message
                }
            } else if (noProtocolsMessage) {
                noProtocolsMessage.style.display = 'none'; // Hide message
            }
        }


		function flipCard(card) {
		    if (card) { // Check if card is not null
		        card.classList.toggle('do-flip');
		    } else {
		        console.error("No card element found");
		    }
		}
            function addCoClient() {
		        const selectedCoClientId = document.getElementById('coClientSelect').value;
		        if (selectedCoClientId) {
		            // Perform the PATCH request
		            fetch(`/addCoClient/${clientId}/${selectedCoClientId}`, {
		                method: 'PATCH',
		                headers: {
		                    'Accept': 'application/json',
		                    'Content-Type': 'application/json',
		                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
		                },
		                credentials: 'include'
		            })
		            .then(response => response.json())
		            .then(data => {
		                if (data.message) {
		                    alert(data.message); // Show success message
		                    window.location.reload(); // Reload page if successful
		                } else if (data.error) {
		                    alert(data.error); // Show error message
		                }
		            })
		            .catch(error => {
		                console.error('Error adding CoClient:', error);
		                alert('Failed to add the CoClient. Error: ' + error.message);
		            });
		        } else {
		            alert('Please select a CoClient first.');
		        }
		    }

	</script th:inline="javascript">
</body>
<div th:insert="~{footer :: main}">...</div>

</html>