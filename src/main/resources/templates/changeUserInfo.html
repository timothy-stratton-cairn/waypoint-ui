<!DOCTYPE html>
<xmlns="http://www.thymeleaf.org">
<div th:insert="~{header :: main}">...</div>
<head>
	<title>Change User Details</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
	<div class = 'container'>
	    <div class="row note_card">
	        <fieldset>
				<legend>Change User Details </legend>
				            <form id="userDetailsForm">
				<div class="form-group">
	                <label for="stepName">Username:</label>
	                <input type="text" id="username" name="username" class="form-control" th:value = "${user.username}">
	            </div>
	            
				
				<div class="form-group">
				    <label for="email">Email:</label>
				    <input type="text" id="email" name="email" class="form-control" th:value="${user.email}">
				</div>
	
				
				<div class="form-group">
	                <label for="stepName">First Name:</label>
	                <input type="text" id="firstName" name="firstName" class="form-control" th:value = "${user.firstName}">
	            </div>
	            
	            <div class="form-group">
	                <label for="stepName">Last Name:</label>
	                <input type="text" id="lastName" name="lastName" class="form-control" th:value = "${user.lastName}">
	            </div>
	       
	            <button type="button" class="btn btn-secondary" onclick="window.history.back();">Back</button>
	            <button type="button" class="btn btn-secondary" onclick="saveUserDetails()">Save</button>
	        </form>
				
				
	        </fieldset>
	        
	    </div>
	</div>
	
	<div class = "container">
		<div class = "row note_card">
			<fieldset>
				<legend> Change Password</legend>
						<form id = "passwordForm">
				    <div class="form-group">
	                    <label for="stepName">Old Password:</label>
	                    <input type="password" id="password" name="oldPassword" class="form-control" th:value = "${user.password}">
	                </div>
	                
	                <div class="form-group">
	                    <label for="stepName">New  Password:</label>
	                    <input type="password" id="password" name="newPassword" class="form-control" th:value = "${user.password}">
	                </div>
	                <button type="button" class="btn btn-secondary" onclick="savePassword()">Save</button>
	                </form>
			</fieldset>
		</div>
	</div>

<script>
    function saveUserDetails() {

		console.log("saveUserDetails: Function called.");

		var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	    
		if (csrfTokenElement && csrfHeaderElement) {
			console.log("saveUserDetails : CSRF elements found.");
		} else {
			console.error("saveUserDetails: CSRF elements not found. This will cause the fetch call to fail.");
		}

	    var email = document.getElementById('email').value;
	    var firstName = document.getElementById('firstName').value;
	    var lastName = document.getElementById('lastName').value;
	
	    // Construct the request URL
	    var requestUrl = `/updateUserDetails/${firstName}/${lastName}/${email}/`;
	

	    fetch(requestUrl, {
	        method: 'PATCH', 
	        	headers: {
		            'Accept': 'application/json',
		            'Content-Type': 'application/json',
		            [csrfHeader]: csrfToken
		        }
	    })
	    .then(response => {
	        if (response.ok) {
	            alert('User details saved successfully.');
	            window.location.reload(); 
	        } else {
	            response.text().then(text => { throw new Error(text); });
	        }
	    })
	    .catch(error => {
	        console.error('Error:', error);
	        alert('Error saving user details.');
	    });
	}
    // Doing this as a different button cause it requires a different type of method a Post as opposed to a Patch
    function savePassword() {
	    // Get password input values
	    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
		    
	    var oldPassword = document.getElementById('oldPassword').value; 
	    var newPassword = document.getElementById('newPassword').value; 
	    
	    // Construct the request URL
	    var requestUrl = `/updateUserPassword/${oldPassword}/${newPassword}/`;
	
	    // Make the POST request
	    fetch(requestUrl, {
        	method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            }
	    })
	    .then(response => {
	        if (response.ok) {
	            alert('Password updated successfully.');
	            window.location.reload(); 
	        } else {
	            alert('Failed to update password.');
	        }
	    })
	    .catch(error => {
	        console.error('Error:', error);
	        alert('Error updating password.');
	    });
	}
</script>
</body>>
<div th:insert="~{footer :: main}">...</div>
</html>