<!DOCTYPE html>
<xmlns="http://www.thymeleaf.org">
<div th:insert="~{header :: main}">...</div>
<head>
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
	<div class = 'container'>
	    <div class="row note_card">
	        <fieldset>
				<legend>Change User Details </legend>
				            <form id="userDetailsForm">
				<div class="form-group">
	                <label for="stepName">Username:</label>
	                <input type="text" id="username" name="username" class="form-control" th:value = "${user.username}">
	            </div>
	            
				
				<div class="form-group">
				    <label for="email">Email:</label>
				    <input type="text" id="email" name="email" class="form-control" th:value="${user.email}">
				</div>
	
				
				<div class="form-group">
	                <label for="stepName">First Name:</label>
	                <input type="text" id="firstName" name="firstName" class="form-control" th:value = "${user.firstName}">
	            </div>
	            
	            <div class="form-group">
	                <label for="stepName">Last Name:</label>
	                <input type="text" id="lastName" name="lastName" class="form-control" th:value = "${user.lastName}">
	            </div>
	       
	            <button type="button" class="btn btn-secondary" onclick="window.history.back();">Back</button>
	            <button type="button" class="btn btn-secondary" onclick="saveUserDetails()">Save</button>
	        </form>
				
				
	        </fieldset>
	        
	    </div>
	</div>
	
	<div class = "container">
		<div class = "row note_card">
			<fieldset>
				<legend> Change Password</legend>
						<form id = "passwordForm">
				    <div class="form-group">
					    <label for="oldPassword">Old Password:</label>
					    <input type="password" id="oldPassword" name="oldPassword" class="form-control">
					</div>
					
					<div class="form-group">
					    <label for="newPassword">New Password:</label>
					    <input type="password" id="newPassword" name="newPassword" class="form-control">
					</div>
					
					<button type="button" class="btn btn-secondary" onclick="savePassword()">Save</button>

	                </form>
			</fieldset>
		</div>
	</div>

<script th:inline="javascript">
	 const clientId = [[${id}]];
    function saveUserDetails(id) {

		console.log("saveUserDetails: Function called.");

		var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

	    var email = document.getElementById('email').value;
	    var firstName = document.getElementById('firstName').value;
	    var lastName = document.getElementById('lastName').value;
	
	    // Construct the request URL
	    var requestUrl = `/updateUserDetails/${clientId}/${firstName}/${lastName}/${email}/`;
	

	    fetch(requestUrl, {
	        method: 'PATCH', 
	        	headers: {
		            'Accept': 'application/json',
		            'Content-Type': 'application/json',
		            [csrfHeader]: csrfToken
		        }
	    })
	    .then(response => {
	        if (response.ok) {
	            alert('User details saved successfully.');
	            window.location.reload(); 
	        } else {
	            response.text().then(text => { throw new Error(text); });
	        }
	    })
	    .catch(error => {
	        console.error('Error:', error);
	        alert('Error saving user details.');
	    });
	}
    // Doing this as a different button cause it requires a different type of method a Post as opposed to a Patch
	 function savePassword() {
	    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
	
	    var oldPassword = document.getElementById('oldPassword').value;
	    var newPassword = document.getElementById('newPassword').value;
	
	    var userObj = {
	        "pwd": oldPassword,
	        "verifyPwd": newPassword
	    };
	
	    fetch('/updateUserPassword/'+clientId, {
	        method: 'POST',
	        headers: {
	            'Accept': 'application/json',
	            'Content-Type': 'application/json',
	            [csrfHeader]: csrfToken
	        },
	        body: JSON.stringify(userObj)
	    })
	    .then(response => response.json().then(data => ({
	        status: response.status,
	        body: data
	    })))
	    .then(result => {
	        if (result.status === 200) {
	            alert('Password updated successfully.');
	            window.location.reload();
	        } else {
	            if (result.body.error) {
	                alert('Error updating password: ' + result.body.error);
	            } else {
	                alert('Failed to update password.');
	            }
	        }
	    })
	    .catch(error => {
	        console.error('Error:', error);
	        alert('Error updating password.');
	    });
	}


</script>
</body>>
<div th:insert="~{footer :: main}">...</div>
</html>