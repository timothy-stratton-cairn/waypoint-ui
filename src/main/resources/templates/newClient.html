<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>New Household</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div th:insert="~{header :: main}">...</div>

<div class="container">
    <div class="container">
        <div th:if="${not #strings.isEmpty(success)}" class="alert alert-success" th:text="${success}">
            <!-- Success message will be displayed here -->
        </div>

        <!-- Display error message -->
        <div id="errorBanner" class="alert alert-danger d-none" role="alert">
            <!-- Error message will be displayed here -->
        </div>
    </div>
    <div class="row note_card">
        <fieldset>
            <legend>New Household</legend>
            <form method="post" id="householdForm">
                <div id="householdInfo">
                    <div class="form-group">
                        <label for="name">Household Name:</label>
                        <input type="text" id="name" name="name" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="description">Description:</label>
                        <input type="text" id="description" name="description" class="form-control">
                    </div>
                </div>

                <div id="primaryContactSection" class="card my-3">
                    <fieldset>
                        <legend>Primary Contacts</legend>
                        <div class="card-body">
                            <ul id="primaryContactList" class="list-group mb-3"></ul>
                            <button type="button" class="btn btn-primary" onclick="togglePrimaryContactFields()">Add Primary Contact</button>
                            <div id="primaryContactFields" class="d-none mt-3">
                                <select id="primaryContactSelect" class="form-control">
                                    <option th:each="user : ${userList}" th:value="${user.id}" th:text="${user.firstName} + ' ' + ${user.lastName}"></option>
                                </select>
                                <button type="button" class="btn btn-success mt-2" onclick="addPrimaryContact()">Confirm Primary Contact</button>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <div id="coClientSection" class="card my-3">
                    <fieldset>
                        <legend>CoClients</legend>
                        <div class="card-body">
                            <ul id="coClientList" class="list-group mb-3"></ul>
                            <button type="button" class="btn btn-primary" onclick="toggleCoClientFields()">Add CoClient</button>
                            <div id="coClientFields" class="d-none mt-3">
                                <select id="coClientSelect" class="form-control">
                                    <option th:each="user : ${userList}" th:value="${user.id}" th:text="${user.firstName} + ' ' + ${user.lastName}"></option>
                                </select>
                                <button type="button" class="btn btn-success mt-2" onclick="addCoClient()">Confirm CoClient</button>
                            </div>
                        </div>
                    </fieldset>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="window.history.back();">Back</button>
                <button type="submit" class="btn btn-success" onclick="saveHousehold(); return false;">Save</button>
            </form>
        </fieldset>
    </div>
</div>

<script>
    let primaryContactAdded = false;
    const primaryContactsIds = [];
    const coClientsIds = [];

    function togglePrimaryContactFields() {
        document.getElementById('primaryContactFields').classList.toggle('d-none');
    }

    function toggleCoClientFields() {
        document.getElementById('coClientFields').classList.toggle('d-none');
    }

    function addPrimaryContact() {
        if (primaryContactAdded) {
            showError('Primary contact already added.');
            return;
        }

        const select = document.getElementById('primaryContactSelect');
        const userId = select.value;
        const userName = select.options[select.selectedIndex].text;

        primaryContactsIds.push(parseInt(userId));
        primaryContactAdded = true;

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = userName;

        const removeButton = document.createElement('button');
        removeButton.className = 'btn btn-danger btn-sm';
        removeButton.textContent = 'Remove';
        removeButton.onclick = () => removePrimaryContact(userId, li);
        li.appendChild(removeButton);

        document.getElementById('primaryContactList').appendChild(li);

        togglePrimaryContactFields();
    }

    function addCoClient() {
        const select = document.getElementById('coClientSelect');
        const userId = select.value;
        const userName = select.options[select.selectedIndex].text;

        coClientsIds.push(parseInt(userId));

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = userName;

        const removeButton = document.createElement('button');
        removeButton.className = 'btn btn-danger btn-sm';
        removeButton.textContent = 'Remove';
        removeButton.onclick = () => removeCoClient(userId, li);
        li.appendChild(removeButton);

        document.getElementById('coClientList').appendChild(li);

        toggleCoClientFields();
    }

    function removePrimaryContact(userId, listItem) {
        const index = primaryContactsIds.indexOf(userId);
        if (index > -1) {
            primaryContactsIds.splice(index, 1);
            primaryContactAdded = false;
            listItem.remove();
        }
    }

    function removeCoClient(userId, listItem) {
        const index = coClientsIds.indexOf(userId);
        if (index > -1) {
            coClientsIds.splice(index, 1);
            listItem.remove();
        }
    }

    function saveHousehold() {
        const name = document.getElementById('name').value;
        const description = document.getElementById('description').value;

        if (!name || !description) {
            showError('Both Household Name and Description are required.');
            return;
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        const householdData = JSON.stringify({
            name: name,
            description: description,
            primaryContactsIds: primaryContactsIds,
            householdAccountsIds: coClientsIds
        });

        fetch('/addHousehold/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: householdData
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                window.location.href = '/clients'; // Redirect on success
            } else {
                showError(data.error || 'Unknown error occurred.');
            }
        })
        .catch(error => {
            showError('Error adding household: ' + error.message);
        });
    }

    function showError(message) {
        const errorBanner = document.getElementById('errorBanner');
        errorBanner.classList.remove('d-none');
        errorBanner.textContent = 'Error: ' + message;
    }
</script>
</body>
</html>
