<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">
<head>
    <title>Edit Homework</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
<div th:insert="~{header :: main}">...</div>

<div class = "container">
	<div class="row note_card">
		<fieldset>
			<legend>Edit Homework</legend>
			<button type="button" class="btn btn-secondary" onclick="window.history.back();">Back</button>
			<div class="form-group">
			    <label for="homeworkName"><strong>Name:</strong></label>
			    <span id="homeworkName"  th:text="${homework.name}">Homework Name</span>
			</div>
			<div class="form-group">
			    <label for="homeworkDetails"><strong>Description:</strong></label>
			    <span id="homeworkDetails" th:text="${homework.description}">Homework Description</span>
			</div>

			<form id="homeworkForm" action="#" method="post">
			    <span class="table-responsive">
			        <table class="table">
			            <thead>
			                <tr>
			                    <th>Question</th>
			                    <th>Type</th>
			                    <th>Response</th>
			                    <th>File Upload</th>
			                </tr>
			            </thead>
			            <tbody>
			                <tr th:each="question : ${homework.questions}" th:id="${question.questionId}">
							    <td th:text="${question.question}"></td>
							    <td th:text="${question.questionType}"></td>
							    <td>
									  <span th:switch="${question.questionType}">
						                <span th:case="'FILE'">
											<input type="file" th:name="response" th:value="${question.userResponse}" />
										</span>
						                <span th:case="'DATE'">
											<input type="date" th:name="response" th:value="${question.userResponse}" />
										</span>
						                <span th:case="'DATETIME'">
											<input type="datetime-local" th:name="response" th:value="${question.userResponse}" />
										</span>
						                <span th:case="'BOOLEAN'">
											<input type="checkbox" th:name="response" th:value="${question.userResponse}" />
										</span>
						                <span th:case="'SELECT_OPTION'">
											<select th:name="${question.questionId}" th:value="${question.userResponse}" >
												<option value="">-- Please select an answer --</option>
												<option id="opt1" value="Option 1">Option 1</option>
												<option id="opt2" value="Option 2">Option 1</option>
												<option id="opt3" value="Option 3">Option 1</option>
											</select>
										</span>
						                <span th:case="'MULTI_SELECT_OPTION'">
											<input type="checkbox" name="MULTI_SELECT_TEST" id="opt1" value="Option 1"><label for="opt1">Option 1</label>
											<input type="checkbox" name="MULTI_SELECT_TEST" id="opt2" value="Option 2"><label for="opt2">Option 2</label>
											<input type="checkbox" name="MULTI_SELECT_TEST" id="opt3" value="Option 3"><label for="opt3">Option 3</label>
										</span>
						                <span th:case="*">
											<input type="text" th:name="response" th:value="${question.userResponse}" />
										</span>
   							 </td>
	   						<td>
								<input type="file" th:name="file" th:value="${question.file}" />
							</td>
						</tr>

			            </tbody>
			        </table>
			        <button type="submit" class="btn btn-primary">Submit Responses</button>
			        <br>
			    </div>
			</form>
		</fieldset>
	</div>
</div>
	
<script th:inline="javascript">
    var homeworkId = [[${homeworkId}]];
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('homeworkForm').addEventListener('submit', function (event) {
            event.preventDefault();

            // Prepare a list to hold DTO objects
            var assignedResponses = [];
            var rows = document.querySelectorAll('tbody tr');
            
        
            rows.forEach(function (row) {
           // Ensure that both input elements exist before accessing their values
                var responseInput = row.querySelector(`input[name='response']`);
                var filePathInput = row.querySelector(`input[name='filePath']`);
                
                var responseValue = responseInput ? responseInput.value : "";
                var filePathValue = filePathInput ? filePathInput.value : "";

                var dto = {
                    id: parseInt(row.id, 10), // Parse the ID as an integer
                    response: responseValue,
                    filePath: filePathValue ? filePathValue : "" // Set to null if empty
                };
                assignedResponses.push(dto);
            });

            // Correctly form the URL with the homeworkId
            fetch(`/assignUserResponseToHomework/${homeworkId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': [[${_csrf.token}]]
                },
                body: JSON.stringify(assignedResponses)
            })
            .then(response => response.json())
            .then(data => {
                alert('Success:', data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        });
    });
</script>







</body>
</html>