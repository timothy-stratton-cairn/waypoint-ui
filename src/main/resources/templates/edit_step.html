<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org">

<head>
	<title>Edit Step</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
	<div th:insert="~{header :: main}">...</div>

	<div class="container">
		<button type="button" class="btn btn-secondary" onclick="window.history.back();">Back</button>
	</div>

	<div class="container">
		<div class="row note_card">
			<fieldset>
				<legend>Edit Step</legend>
				<form th:action="@{/saveStep}" method="post">
					<input type="hidden" name="stepId" th:value="${step.id}">
					<div class="form-group">
						<label for="stepName">Name:</label>
						<input type="text" id="stepName" name="stepName" class="form-control" th:value="${step.name}">
					</div>
					<div class="form-group">
						<label for="stepDetails">Description:</label>
						<textarea id="stepDetails" name="stepDetails" class="form-control" rows="3"
							th:text="${step.description}"></textarea>
					</div>
					<button type="button" class="btn btn-secondary" th:onclick="saveStep(${stepId});">Save</button>
				</form>
			</fieldset>
		</div>
	</div>

	<!-- Homework Form -->
	<div class="container">
		<div class="row note_card">
			<fieldset>
				<legend>Assigned Homework</legend>
				<div class="table-responsive">
					<table class="table" id="homeworkTable">
						<thead>
							<tr>
								<th>Name</th>

							</tr>
						</thead>
						<tbody>
							<tr th:each="homework : ${step.homework}">
								<td th:text="${homework.name}">Homework Name</td>
							</tr>
						</tbody>
					</table>
				</div>
				<!-- Updated to include selection and button in one place -->
				<select class="form-control mt-2" id="homeworkTemplateDropdown">
					<option value="">Select Homework Template</option>
					<option th:each="homework : ${homework}" th:value="${homework.id}" th:text="${homework.name}">
						Homework Template Name</option>
				</select>
				<button type="button" class="btn btn-primary mt-2" onclick="addHomeworkTemplate();">Add
					Homework</button>
			</fieldset>
		</div>
	</div>


	<!-- Homework Template Selection -->
	<div class="container mt-3">
		<div id="homeworkTemplateSelector" style="display:none;">
			<select class="form-control mt-2" id="homeworkTemplateDropdown" name="homeworkTemplateId">
				<option value="">Select Homework Template</option>
				<option th:each="homework : ${homework}" th:value="${homework.id}" th:text="${homework.name}">Homework
					Template Name</option>
			</select>
			<button type="button" class="btn btn-secondary mt-2" onclick="confirmHomeworkTemplate()">Confirm</button>
		</div>
	</div>



	<script th:inline="javascript">
		// Example variable, replace with actual step ID
		var stepId = [[${stepId}]];

		document.getElementById('btnAddHomeworkTemplate').addEventListener('click', function () {
			document.getElementById('homeworkTemplateSelector').style.display = 'block';
		});

		function saveStep(id) {
			alert("Saved")
		}

		function confirmHomeworkTemplate() {
			var csrfTokenElement = document.querySelector('meta[name="_csrf"]');
			var csrfHeaderElement = document.querySelector('meta[name="_csrf_header"]');
			var csrfToken = csrfTokenElement ? csrfTokenElement.getAttribute('content') : 'no_token';
			var csrfHeader = csrfHeaderElement ? csrfHeaderElement.getAttribute('content') : 'no_header';
			var homeworkTemplateId = document.getElementById('homeworkTemplateDropdown').value;
			if (!homeworkTemplateId) {
				alert('Please select a Homework Template.');
				return;
			}
			var stepId = [[${stepId}]]; // Ensure this variable is correctly populated
			// Use Thymeleaf to insert the CSRF token into the fetch request


			fetch('/addHomeworkTemplateToStep/' + stepId + '/' + homeworkTemplateId + '/', {
				method: 'PATCH', // or 'POST', as appropriate
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json',
					[csrfHeader]: csrfToken
				},
				credentials: 'include'
			})
				.then(response => {
					if (response.ok) {
						alert('Homework Template added successfully.');
						window.location.reload();
					} else {
						alert('Failed to add Homework Template.');
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('Error adding Homework Template.');
				});
		}

	</script>

</body>

</html>